{% extends 'unfold/layouts/base_simple.html' %}
{% load i18n unfold %}

{% block breadcrumbs %}{% endblock %}

{% block content %}
    {% include "unfold/helpers/messages.html" %}

    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ Unfold */
        html.dark .custom-card { background-color: #111827 !important; border-color: #1f2937 !important; color: #f9fafb !important; }
        html.dark .custom-text-muted { color: #9ca3af !important; }
        html.dark .custom-table-bg { background-color: #111827 !important; border-color: #1f2937 !important; }
        html.dark .custom-table-header { background-color: #1f2937 !important; border-bottom-color: #374151 !important; color: #9ca3af !important; }
        html.dark .custom-table-row { background-color: #111827 !important; border-bottom-color: #1f2937 !important; color: #e5e7eb !important; }
        html.dark .custom-table-row:hover { background-color: #1f2937 !important; }
        html.dark .custom-progress-bg { background-color: #374151 !important; }
    </style>

    {% if not request.user.is_superuser %}
    <div class="mb-8 p-6 bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 flex flex-col md:flex-row gap-6 justify-between items-center">
        <div>
            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-600">schedule</span> 
                –†–∞–±–æ—á–∏–π –¥–µ–Ω—å
            </h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">–û—Ç–º–µ—á–∞–π—Ç–µ –≤—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞ –∏ —É—Ö–æ–¥–∞. –û—Ç—á–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è.</p>
        </div>

        <div class="flex flex-wrap gap-3">
            {% if not has_active_shift %}
                <form action="/admin/timetracking/workshift/start-shift/" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold transition-all shadow flex items-center gap-2">
                        <span class="material-symbols-outlined">play_circle</span> –Ø –ø—Ä–∏—à–µ–ª (–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É)
                    </button>
                </form>
            
            {% else %}
                <a href="/admin/reports/dailyreport/add/" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold transition-all shadow flex items-center gap-2">
                    <span class="material-symbols-outlined">edit_document</span> –ó–∞–ø–æ–ª–Ω–∏—Ç—å –æ—Ç—á–µ—Ç
                </a>

                {% if not has_report_today %}
                    <button disabled class="bg-gray-200 dark:bg-gray-700 text-gray-500 px-6 py-3 rounded-lg font-bold cursor-not-allowed flex items-center gap-2" title="–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏—Ç–µ –æ—Ç—á–µ—Ç!">
                        <span class="material-symbols-outlined">block</span> –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–Ω—å (–ù—É–∂–µ–Ω –æ—Ç—á–µ—Ç)
                    </button>
                {% else %}
                    <form action="/admin/timetracking/workshift/end-shift/" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold transition-all shadow flex items-center gap-2">
                            <span class="material-symbols-outlined">stop_circle</span> –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–Ω—å (–£–π—Ç–∏)
                        </button>
                    </form>
                {% endif %}
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if hot_tasks %}
    <div class="mb-8">
        <h3 class="mb-4 text-xl font-bold text-red-600 flex items-center">
            <span class="material-symbols-outlined mr-2">local_fire_department</span> –ì–æ—Ä—è—â–∏–µ –∑–∞–¥–∞—á–∏
        </h3>
        <div class="custom-table-bg overflow-x-auto shadow-sm rounded-lg border border-red-200 dark:border-red-900 bg-white">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="custom-table-header text-xs text-gray-700 uppercase bg-red-50 dark:bg-gray-800 border-b border-red-200 dark:border-red-900">
                    <tr>
                        <th scope="col" class="px-6 py-3">–ó–∞–¥–∞—á–∞</th>
                        <th scope="col" class="px-6 py-3">–î–µ–¥–ª–∞–π–Ω</th>
                        <th scope="col" class="px-6 py-3">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                        <th scope="col" class="px-6 py-3 text-right">–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in hot_tasks %}
                    <tr class="custom-table-row bg-white border-b hover:bg-red-50 dark:hover:bg-gray-800 transition-colors">
                        <td class="px-6 py-4 font-bold text-red-600 dark:text-red-400">{{ task.title }}</td>
                        <td class="px-6 py-4 font-medium text-red-500">{{ task.deadline|date:"d.m.Y H:i" }}</td>
                        <td class="px-6 py-4 font-medium">{{ task.assigned_to.first_name }} {{ task.assigned_to.last_name }}</td>
                        <td class="px-6 py-4 text-right">
                            <a href="{% url 'admin:tasks_task_change' task.id %}" class="font-medium text-blue-600 hover:underline">–û—Ç–∫—Ä—ã—Ç—å</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if kpi %}
    <div class="grid grid-cols-1 gap-6 mb-6 md:grid-cols-2 lg:grid-cols-3">
        {% for card in kpi %}
            <div class="custom-card flex flex-col p-6 bg-white border border-gray-200 rounded-lg shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="custom-text-muted text-sm font-medium text-gray-500">{{ card.title }}</h3>
                </div>
                <div class="flex items-baseline text-3xl font-bold text-gray-900">{{ card.metric }}</div>
                {% if card.footer %}
                <div class="mt-4 flex items-center text-sm">
                    <span class="text-xs font-medium px-2 py-0.5 rounded border 
                        {% if card.color == 'success' %}bg-green-100 text-green-700 border-green-200
                        {% elif card.color == 'warning' %}bg-yellow-100 text-yellow-700 border-yellow-200
                        {% elif card.color == 'danger' %}bg-red-100 text-red-700 border-red-200
                        {% else %}bg-blue-100 text-blue-700 border-blue-200{% endif %}">
                        {{ card.footer }}
                    </span>
                </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if progress %}
    <div class="grid grid-cols-1 gap-6 mb-8">
        {% for prog in progress %}
        <div class="custom-card p-6 bg-white border border-gray-200 rounded-lg shadow-sm">
            <div class="flex justify-between mb-2">
                <span class="custom-text-muted text-sm font-medium text-gray-700">{{ prog.title }}</span>
                <span class="custom-text-muted text-sm font-bold text-gray-700">{{ prog.value }}%</span>
            </div>
            <div class="custom-progress-bg w-full bg-gray-200 rounded-full h-2.5">
                <div class="{% if prog.color == 'success' %}bg-green-500{% else %}bg-blue-500{% endif %} h-2.5 rounded-full" style="width: {{ prog.value }}%"></div>
            </div>
            <p class="custom-text-muted mt-2 text-sm text-gray-500">{{ prog.description }}</p>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        
        {% if new_leads %}
        <div class="flex flex-col">
            <h3 class="custom-text-muted mb-4 text-lg font-semibold text-gray-900">üîî –°–≤–æ–±–æ–¥–Ω—ã–µ –∑–∞—è–≤–∫–∏ (–°–∞–π—Ç)</h3>
            <div class="custom-table-bg overflow-x-auto shadow-sm rounded-lg border border-gray-200 bg-white">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="custom-table-header text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th scope="col" class="px-4 py-3">–ò–º—è / –ö–æ–Ω—Ç–∞–∫—Ç</th>
                            <th scope="col" class="px-4 py-3">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
                            <th scope="col" class="px-4 py-3 text-right">–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lead in new_leads %}
                        <tr class="custom-table-row bg-white border-b hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3 font-medium whitespace-nowrap">
                                <div>{{ lead.full_name|truncatechars:20 }}</div>
                                <div class="text-xs text-gray-400">{{ lead.phone }}</div>
                            </td>
                            <td class="px-4 py-3 text-xs">{{ lead.get_direction_display|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</td>
                            <td class="px-4 py-3 text-right">
                                <a href="{% url 'admin:leads_lead_change' lead.id %}" class="bg-blue-600 text-white text-xs px-3 py-1 rounded hover:bg-blue-700 transition">–ó–∞–±—Ä–∞—Ç—å</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {% if my_clients %}
        <div class="flex flex-col">
            <h3 class="custom-text-muted mb-4 text-lg font-semibold text-gray-900">üë• –ú–æ–∏ –Ω–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</h3>
            <div class="custom-table-bg overflow-x-auto shadow-sm rounded-lg border border-gray-200 bg-white">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="custom-table-header text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th scope="col" class="px-4 py-3">–ö–ª–∏–µ–Ω—Ç</th>
                            <th scope="col" class="px-4 py-3 text-right">–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for client in my_clients %}
                        <tr class="custom-table-row bg-white border-b hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3 font-medium whitespace-nowrap">
                                <a href="{% url 'admin:clients_client_change' client.id %}" class="hover:underline text-blue-600 font-medium">
                                    {{ client.full_name|truncatechars:25 }}
                                </a>
                                {% if client.is_priority %}‚≠ê{% endif %}
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="text-[10px] font-bold uppercase px-2 py-1 rounded border border-gray-200 bg-gray-100 text-gray-600">
                                    {{ client.get_status_display }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {% if my_deals %}
        <div class="flex flex-col">
            <h3 class="custom-text-muted mb-4 text-lg font-semibold text-gray-900">üíµ –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏</h3>
            <div class="custom-table-bg overflow-x-auto shadow-sm rounded-lg border border-gray-200 bg-white">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="custom-table-header text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th scope="col" class="px-4 py-3">–°–¥–µ–ª–∫–∞</th>
                            <th scope="col" class="px-4 py-3 text-right">–û–ø–ª–∞—Ç–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for deal in my_deals %}
                        <tr class="custom-table-row bg-white border-b hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3 font-medium whitespace-nowrap">
                                <a href="{% url 'admin:analytics_deal_change' deal.id %}" class="hover:underline text-blue-600">
                                    #{{ deal.id }} - {{ deal.client.full_name|truncatechars:15 }}
                                </a>
                            </td>
                            <td class="px-4 py-3 text-right">
                                {% if deal.paid_amount_usd >= deal.total_to_pay_usd %}
                                    <span class="font-bold text-green-500">${{ deal.paid_amount_usd }}</span>
                                {% else %}
                                    <span class="font-bold text-yellow-500">${{ deal.paid_amount_usd }} / ${{ deal.total_to_pay_usd }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {% if my_tasks %}
        <div class="flex flex-col">
            <h3 class="custom-text-muted mb-4 text-lg font-semibold text-gray-900">üìù –ú–æ–∏ –∑–∞–¥–∞—á–∏ (–í —Ä–∞–±–æ—Ç–µ)</h3>
            <div class="custom-table-bg overflow-x-auto shadow-sm rounded-lg border border-gray-200 bg-white">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="custom-table-header text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th scope="col" class="px-4 py-3">–ó–∞–¥–∞—á–∞</th>
                            <th scope="col" class="px-4 py-3 text-right">–î–µ–¥–ª–∞–π–Ω</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in my_tasks %}
                        <tr class="custom-table-row bg-white border-b hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3 font-medium whitespace-nowrap">
                                <a href="{% url 'admin:tasks_task_change' task.id %}" class="hover:underline text-blue-600">
                                    {{ task.title|truncatechars:25 }}
                                </a>
                            </td>
                            <td class="px-4 py-3 text-right font-medium">
                                {% if task.deadline %}
                                    {{ task.deadline|date:"d.m" }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

    </div>

    {{ block.super }}
{% endblock %}