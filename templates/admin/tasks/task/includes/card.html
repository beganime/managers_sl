<style>
    /* Основная карточка */
    html.dark .custom-kanban-card {
        background-color: #1f2937 !important; /* Чуть светлее фона доски для эффекта "стикера" */
        border-color: #374151 !important;
    }
    html.dark .custom-kanban-card:hover {
        border-color: #3b82f6 !important; /* Голубая рамка при наведении */
    }
    
    /* Тексты */
    html.dark .custom-kanban-title {
        color: #f3f4f6 !important;
    }
    html.dark .custom-kanban-desc {
        color: #9ca3af !important;
    }
    
    /* Разделитель подвала */
    html.dark .custom-kanban-divider {
        border-top-color: rgba(75, 85, 99, 0.4) !important;
    }

    /* Цветные бейджи приоритетов */
    html.dark .custom-badge-red {
        background-color: rgba(153, 27, 27, 0.2) !important;
        color: #f87171 !important;
        border-color: rgba(153, 27, 27, 0.4) !important;
    }
    html.dark .custom-badge-yellow {
        background-color: rgba(146, 64, 14, 0.2) !important;
        color: #fbbf24 !important;
        border-color: rgba(146, 64, 14, 0.4) !important;
    }
    html.dark .custom-badge-green {
        background-color: rgba(20, 83, 45, 0.2) !important;
        color: #4ade80 !important;
        border-color: rgba(20, 83, 45, 0.4) !important;
    }

    /* Аватар-заглушка с инициалами */
    html.dark .custom-avatar-fallback {
        background-color: rgba(30, 58, 138, 0.5) !important;
        color: #93c5fd !important;
        border-color: rgba(30, 58, 138, 0.8) !important;
    }
    html.dark .custom-avatar-img {
        border-color: #374151 !important;
    }
</style>

<div class="custom-kanban-card bg-white p-4 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-all cursor-grab active:cursor-grabbing group relative" 
     data-id="{{ task.id }}"
     ondblclick="window.location.href='{% url 'admin:tasks_task_change' task.id %}'">
    
    <div class="flex justify-between items-start mb-3">
        {% if task.priority == 'high' %}
            <span class="custom-badge-red text-[9px] font-black uppercase tracking-tighter text-red-600 bg-red-50 px-2 py-0.5 rounded-md border border-red-100">Срочно</span>
        {% elif task.priority == 'medium' %}
            <span class="custom-badge-yellow text-[9px] font-black uppercase tracking-tighter text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded-md border border-yellow-100">Важно</span>
        {% else %}
            <span class="custom-badge-green text-[9px] font-black uppercase tracking-tighter text-green-600 bg-green-50 px-2 py-0.5 rounded-md border border-green-100">Низкий</span>
        {% endif %}
        
        <a href="{% url 'admin:tasks_task_change' task.id %}" class="custom-kanban-desc text-gray-300 hover:text-primary-500 transition-colors">
            <span class="material-symbols-outlined text-[18px]">open_in_new</span>
        </a>
    </div>

    <h3 class="custom-kanban-title font-bold text-gray-800 mb-1 text-sm leading-snug group-hover:text-primary-600 transition-colors">
        {{ task.title }}
    </h3>
    
    <div class="custom-kanban-desc text-[11px] text-gray-500 mb-4 line-clamp-2">
        {{ task.description|striptags|default:"Нет описания" }}
    </div>

    <div class="custom-kanban-divider flex justify-between items-center pt-3 border-t border-gray-50 mt-auto">
        
        <div class="flex items-center gap-2">
            {% if task.assigned_to.avatar %}
                <img src="{{ task.assigned_to.avatar.url }}" class="custom-avatar-img w-6 h-6 rounded-full object-cover border border-gray-200 shadow-sm" title="{{ task.assigned_to.get_full_name|default:task.assigned_to.email }}">
            {% else %}
                <div class="custom-avatar-fallback w-6 h-6 rounded-full bg-primary-100 flex items-center justify-center text-[9px] font-black text-primary-700 border border-primary-200">
                    {# Фикс NoneType: используем slice вместо first #}
                    {% if task.assigned_to.first_name %}
                        {{ task.assigned_to.first_name|slice:":1"|upper }}
                    {% else %}
                        {{ task.assigned_to.email|slice:":1"|upper }}
                    {% endif %}
                </div>
            {% endif %}
            
            <span class="custom-kanban-desc text-[10px] font-medium text-gray-600 truncate max-w-[70px]">
                {{ task.assigned_to.first_name|default:task.assigned_to.email|truncatechars:10 }}
            </span>
        </div>

        {% if task.deadline %}
            <div class="flex items-center text-[10px] font-bold {% if task.status != 'done' %}text-orange-500{% else %}custom-kanban-desc text-gray-400{% endif %}">
                <span class="material-symbols-outlined text-[12px] mr-1">calendar_today</span>
                {{ task.deadline|date:"d.m" }}
            </div>
        {% endif %}
        
    </div>
</div>